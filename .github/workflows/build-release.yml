name: Build and Release LocationSimulator

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Build LocationSimulator
        run: |
          xcodebuild -project LocationSimulator.xcodeproj \ \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
            -scheme LocationSimulator \
            -configuration Release \
            -derivedDataPath ./build \
            clean build
      
      - name: Create .app bundle
        run: |
          mkdir -p ./dist
          cp -R ./build/Build/Products/Release/LocationSimulator.app ./dist/
      
      - name: Create DMG
        run: |
          brew install create-dmg
          create-dmg \
            --volname "LocationSimulator" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "LocationSimulator.app" 200 190 \
            --hide-extension "LocationSimulator.app" \
            --app-drop-link 600 185 \
            "LocationSimulator-${{ github.ref_name }}.dmg" \
            "./dist/"
      
      - name: Create ZIP archive
        run: |
          cd ./dist
          zip -r ../LocationSimulator-${{ github.ref_name }}.zip LocationSimulator.app
          cd ..
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: LocationSimulator ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## LocationSimulator ${{ github.ref_name }}
            
            ### What's New
            - Updated for macOS 12.0+ compatibility
            - Xcode 16 build support
            - iOS 18 SDK compatibility
            
            ### Downloads
            - **DMG**: Recommended for most users
            - **ZIP**: Alternative installation method
            
            ### Requirements
            - macOS 12.0 (Monterey) or later
            - iOS 16+ device (iOS 18 fully supported)
      
      - name: Upload DMG to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./LocationSimulator-${{ github.ref_name }}.dmg
          asset_name: LocationSimulator-${{ github.ref_name }}.dmg
          asset_content_type: application/x-apple-diskimage
      
      - name: Upload ZIP to Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./LocationSimulator-${{ github.ref_name }}.zip
          asset_name: LocationSimulator-${{ github.ref_name }}.zip
          asset_content_type: application/zip
